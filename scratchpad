import csv
from datetime import datetime, timezone
import time
import math

# Setup
allowed_crit_age = -14
allowed_high_age = -14
now = int(time.time())

# Open output file
with open('vulnage.csv', mode='w', newline='') as outfile:
    writer = csv.writer(outfile)

    # Open and read input file
    with open('vulnonly.csv', newline='') as csvfile:
        reader = csv.reader(csvfile)

        for row in reader:
            if len(row) < 2:
                continue  # Skip invalid lines

            severity = row[0].strip('"')
            date_str = row[1].strip('"')

            try:
                dt = datetime.strptime(date_str, "%Y-%m-%dT%H:%M:%SZ")
                timestamp = int(dt.replace(tzinfo=timezone.utc).timestamp())
                age = math.trunc((timestamp - now) / 86400)
            except Exception as e:
                age = "invalid"
                result = "invalid"
                writer.writerow([result, age] + row)
                continue

            # Apply blocking logic
            if severity == "Critical":
                result = "blocked" if age <= allowed_crit_age else "ok"
            elif severity == "High":
                result = "blocked" if age <= allowed_high_age else "ok"
            else:
                result = "ok"

            # Write to output file
            writer.writerow([result, age] + row)
