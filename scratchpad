import pandas as pd
from datetime import datetime

# Load CSV file
df = pd.read_csv('input.csv')

# Step 1: Parse 'Age' column (D) to extract date and calculate days difference
today = datetime(2025, 4, 25)

def compute_days_old(age_str):
    try:
        date_part = age_str.split(' ')[0]  # Get date before first space
        age_date = pd.to_datetime(date_part)
        return (today - age_date).days
    except Exception:
        return None  # Will become NaN in pandas

df['Age as of Today'] = df['Age'].apply(compute_days_old)

# Step 2: Remove rows where Age as of Today is NaN
df = df.dropna(subset=['Age as of Today'])

# Step 3: Create 'FormattedNamespace'
df['FormattedNamespace'] = df['Namespace'].apply(lambda x: f"cmeprod/{str(x).lower()}")

# Step 4: Write to Excel
df.to_excel('report_with_columns.xlsx', index=False)

# Step 5: Create pivot table
pivot_df = df.pivot_table(
    index='FormattedNamespace',
    values='Age as of Today',
    aggfunc=['mean', 'max', 'min']
)

# Flatten column names
pivot_df.columns = ['Avg', 'Max', 'Min']
pivot_df = pivot_df.reset_index()

# Step 6: Write both original and pivot to Excel
with pd.ExcelWriter('report_with_columns_and_pivot.xlsx', engine='openpyxl') as writer:
    df.to_excel(writer, sheet_name='ProcessedData', index=False)
    pivot_df.to_excel(writer, sheet_name='Pivot', index=False)
